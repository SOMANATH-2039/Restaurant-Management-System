{% extends "main.html" %}
{% block main %}


<section class="h-100">
  <div class="container h-100 py-5">
    
    <div class="row d-flex justify-content-center align-items-center h-100">
      <div class="col-10">

        <div class="d-flex justify-content-between align-items-center mb-4">
          
          <h3 class="fw-normal mb-0"></h3>
          <h1>Your Cart</h1>
          <div>
            <p class="mb-0"><span class="text-muted">Sort by:</span> <a href="#!" class="text-body">price 
              <i class="fas fa-angle-down mt-1"></i></a></p>
          </div>
        </div>

        {% if cart and cart.cart_items.all %}
        <!-- Cart Items List -->
        
          {% for item in cart.cart_items.all %}
          
            <div class="card rounded-3 mb-4">
              <div class="card-body p-4">
                <div class="row d-flex justify-content-between align-items-center">
                  
                  <!-- Product Image -->
                  <div class="col-md-2 col-lg-2 col-xl-2">
                    <img
                      src="{{ item.product.image.url }}"
                      class="img-fluid rounded-3" alt="{{ item.product.name }}">
                  </div>
                  
                  <!-- Product Name -->
                  <div class="col-md-3 col-lg-3 col-xl-3">
                    <p class="lead fw-normal mb-2">{{ item.product.name }}</p>
                    <p><span class="text-muted">Category: </span>{{ item.product.category.name }}</p>
                  </div>

                  <!-- Quantity Update Form -->
                  <div class="col-md-3 col-lg-3 col-xl-2 d-flex">
                    <form method="POST" action="{% url 'update_cart' item.id %}">
                      {% csrf_token %}
                      <div class="d-flex align-items-center">
                        <!-- Minus Button -->
                        <button data-mdb-button-init data-mdb-ripple-init class="btn btn-link px-2"
                          onclick="this.parentNode.querySelector('input[type=number]').stepDown()">
                          <i class="fas fa-minus"></i>
                        </button>
                    
                        <!-- Quantity Input -->
                        <input id="form1" min="1" name="quantity" value="{{ item.quantity }}" type="number"
                          class="form-control form-control-sm mx-2" style="width: 60px;" />
                    
                        <!-- Plus Button -->
                        <button data-mdb-button-init data-mdb-ripple-init class="btn btn-link px-2"
                          onclick="this.parentNode.querySelector('input[type=number]').stepUp()">
                          <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    </form>
                  </div>

                  <!-- Product Price -->
                  <div class="col-md-3 col-lg-2 col-xl-2 offset-lg-1">
                    <h5 class="mb-0">&#8377;{{ item.product.price }}</h5>
                  </div>

                  <!-- Remove Item -->
                  <div class="col-md-1 col-lg-1 col-xl-1 text-end">
                    <a href="{% url 'remove_from_cart' item.id %}" class="text-danger"><i class="fas fa-trash fa-lg"></i></a>
                  </div>
                </div>
              </div>
            </div>
          
          {% endfor %}
        

        <!-- Cart Totals -->
        <div class="d-flex align-items-center justify-content-between">
        <h1>Total Items: {{ cart_total_items }}</h1>
        <h1>Total Price: &#8377;{{ cart_total_price }}</h1>
        </div>

        {% else %}
        <p>Your cart is empty.</p>
        {% endif %}

        <!-- Discount Code -->
        <div class="card mb-4">
          <div class="card-body p-4 d-flex flex-row">
            <div data-mdb-input-init class="form-outline flex-fill">
              <input type="text" id="form1" class="form-control form-control-lg" placeholder="Discount code" />
              <!-- <label class="form-label" for="form1">Discound code</label> -->
            </div>
            <button  type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-outline-warning btn-lg ms-3">Apply</button>
          </div>
        </div>

        <!-- Proceed to Pay Button -->
        <div class="card">
          <div class="card-body">
           <a href="{% url 'checkout' %}">
             <button type="button" id="chk-button" data-mdb-button-init data-mdb-ripple-init class="btn btn-warning btn-block btn-lg">Proceed to Checkout</button>
            </a>
            </div>
        </div>

      </div>
    </div>
  </div>
</section>
<!-- Include Razorpay Checkout Script -->
 <!-- Razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
 <!-- End Razorpay -->
<script >
        var options = {
          "key": "{{ razorpay_key }}",  // Razorpay Key ID
          "amount": "{{ amount }}00", // Amount in paise
          "currency": "INR",
          "name": "Fearn",
          "description": "Payment for your cart",
          "order_id": "{{ razorpay_order_id }}", // Razorpay Order ID
          "handler": function (response){
            // Post payment details to your server
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'payment_success' %}";  // Django URL for success

            var csrf_token = '{{ csrf_token }}';
            var inputs = [
              { name: 'razorpay_payment_id', value: response.razorpay_payment_id },
              { name: 'razorpay_order_id', value: response.razorpay_order_id },
              { name: 'razorpay_signature', value: response.razorpay_signature },
              { name: 'csrfmiddlewaretoken', value: csrf_token }
            ];

            inputs.forEach(function(inputData) {
              var input = document.createElement('input');
              input.type = 'hidden';
              input.name = inputData.name;
              input.value = inputData.value;
              form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
          },
          "theme": {
            "color": "#3399cc"
          }
        };

        var rzp1 = new Razorpay(options);

        document.getElementById('rzp-button').onclick = function(e){
          rzp1.open();
          e.preventDefault();
        }
</script>


{% endblock main %}